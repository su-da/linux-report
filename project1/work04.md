计步原理
========

算法分析
--------

一般专用计步器是直接由硬件平台实现，同样，手机计步器软件的实现是根据手机
内置加速度计来感应手机的运动情况，并且能够根据加速度的数据，通过特定的算
法来计步。为此，我们设计一个小测试程序来记录手机传感器的数据。图
\ref{ch4accsensor} 所示为当手机震动 8 次加速度计某一参数所记录下的数据经
Matlab 分析所画图形，横坐标表示时间点数，纵坐标代表不同时刻的值 (由于离
散图形不易于观察，现将其画成模拟形式)。

![真机传感器数据分析\label{ch4accsensor}](media/ch4accsensor.pdf)

可以看出，手机在震动时呈现出这样一个特点：每震动一下，其波形将会相应的波
动一下，出现一个相应的尖峰 (谷)。为此，我们设想了以下几种计步算法及相应
的优缺点：

-   峰 (谷) 值检测法

峰 (谷) 值检测法的意义是通过程序分析数据，将数据存进数组 array 里，每当
检测到 `array[i-1] < array[i]`，并且当 `array[i] > array[i+1]` 时，则在
第 i 个数据处为峰值，此时步数加 1。这种方法在实现时计算量相对较大，增加
了手机运行时的负荷，并且运行时内存开销也较大，可见这种方法是不经济的。另
外，从图 \ref{ch4accsensor} 可以看出，真机在震动时，每震动一下，出现的尖
峰不止一个，这实际上增大了计步的步数，为计步带来误差。

-   数值放大法

由于不同时刻的数值较为接近，如果将这些数值放大 (如通过 log 函数)，再作差
值，当差值大于某一固定数值时步数加 1。通过测试，这种方法可以相对精确地计
步，但由于涉及到较为复杂的计算函数，系统开销同样较大。

-   波形整形法

这种方法类似于硬件电路中的波形整形。若用硬件平台实现，则可以将这些数值通
过比较器，当数值大于阈值时，为高电平，低于阈值时则为低电平，再检测上升沿
即可计步，其硬件实现等效电路如图 \ref{ch4filterblock} 所示。在软件实现的
情况下，同样可以参照此方法，虚线框内为软件实现等效，即设定一阈值，当传感
器的数值大于阈值时，设定一整数 i 为 1，否则为 0。可以设想，当某一序列数
值经“整形”后i为 11110001111001110，只需检测到由 0 跳变为 1 即可计为 1 步。
这种方法实现时只需两个变量即可，减少了手机运行时占用的内存，并且没有涉
及到复杂的函数，可见这种方法是较为经济的。

![硬件电路实现计数功能等效框图
\label{ch4filterblock}](media/ch4filterblock.pdf)

通过上面的介绍，我们选择波形整形法。这种方法还有另外一个优点，用户可以设
定不同的阈值来改变运动模式 (或传感器的灵敏度)。采用波形整形法，将阈值设
为 -5，则波形整形为图 \ref{ch4filterout-5} 示。

![阈值设为-5时整形后波形
\label{ch4filterout-5}](media/ch4filterout-5.pdf)

从图 \ref{ch4filterout-5} 可以看出，每当程序检测到一个上升沿时，程序计为
1 步，精确度可以得到保证。

如果将阈值设为 -4，则图 \ref{ch4accsensor} 转化后的波形如图
\ref{ch4filterout-4} 示。

![阈值设为-4时整形后波形
\label{ch4filterout-4}](media/ch4filterout-4.pdf)

比较图 \ref{ch4filterout-5} 和图 \ref{ch4filterout-4}，可以看出，当阈值
设定为 -4 时，可能发生漏检。而当阈值设定为过大或过小时，又增大了检测的步
数。这就要求必须设定合理的阈值。当要求灵敏度较高时，可以适当降低阈值，相
反，当灵敏度要求较低时，可以适当增大阈值标准。在设计程序的过程中，为方便
测试程序逻辑的正确性，采用了模拟传感器，两者的区别仅是阈值的设置不同，而
程序内部实现机理是一样的。

传感器类型的选择
----------------

传感器的数据有三种，分别为加速度计 (accelerometer)，磁场 (magnetic
field) 和方向 (orientation)。在设计计步器程序时，为了简化程序设计而又不
失去实际意义，选择利用加速度计的数值来分析，而忽略磁场和方向的数值。这是
因为在一特定区域，磁场和方向的变化不会影响计步效果。

传感器的每一种类型都有三个参量，为了能够获得较为精确的计步数据，现考虑加
速度的三个参数。从加速度的三个参数波形可以看出，它们每震动 1 次，都会出
现对应的峰值。理论上讲，检测出一次震动周期中的最大值时，计步加 1，即可以
正确得出步数。

为了能够较为精确的计步数据，可以采用以下几种方式：

1.  直接法。比较以上三个参数的波形，可以发现，每当手机震动 1 次，三个参
    数都相应地出现了峰值，用前面介绍的波形整形法，设定好合适的阈值，即可
    得到较为精确的计步数值。这种方式实现起来简单，没有涉及到复杂的运算，
    较为经济。

2.  间接法。由于加速度是一个矢量，如图 \ref{ch4accvector} 示，其中原点即
    为手机所在位置。单一地考虑一个参数可能会对计步带来误差，现将这三个参
    数的数值经过运算计算出加速度模值大小，再通过波形整形得到更可靠的加速
    度信息。

![加速度矢量示意图\label{ch4accvector}](media/ch4accvector.pdf)

虽然直接法的使用较为简单，没有涉及到复杂的数据运算，但由于手机在使用过程
中的震动时十分复杂的，单一地采用分析加速度某一个参数显然是不合适的。间接
法的使用虽然较为复杂，手机的运算量也较大，但这样可以提高计步的精确度。因
此，我们在程序设计中采用的是间接法，提高了程序运行的可靠性。
