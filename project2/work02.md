# 开发平台概述

## 可行性

ZW1402 电流表具有一定的通信功能，支持 RS232 或 RS485 通信，可以通过编写
相应的软件和它通信，使其实现自动化测量和数据处理。

而 LabWindows/CVI 是面向计算机测控领域的交互式 C 语言软件，可以在多种操
作系统 (如 Windows98/NT/2000、MacOS 和 UNIX) 下运行。它以 ANSI C 为核心，
将功能强大、使用灵活的 C 语言与数据采集、分析和表达等测控专业工具有机
结合。它的集成化开发、交互式编程方法、丰富的功能面板和库函数大大增强了 C
语言的功能，为熟悉 C 语言的开发人员开发检测、数据采集、过程监控等系统提
供了一个理想的软件开发环境。

LabWindows/CVI 开发软件对每一个函数都提供了一个函数面板，程序员可以通过
函数面板交互地输入函数的每个参数。在脱离主程序 C 源代码的情况下，可直接
在函数面板中执行函数操作，并能方便地把函数语句嵌入 C 源代码中，还可通过
变量声明窗口交互地声明变量。这种交互式编程技术大大地减少了源代码语句的键
入量，减少了程序语句可能出现错误的机会，提高了工程设计的效率和可靠性。

LabWindows/CVI 提供的丰富的函数库，让我们只需了解在设计中用到的函数库的
定义及用法，便能够通过它迅速、方便地编写各种不同功能控件的相应程序，通过
事件驱动与回调函数方式来实现设计的控制界面的功能调用。

## ZW1402 仪表及其通讯规约

ZW1402 电流表的测量对象为 \SI{45}{\hertz}~\SI{50}{\hertz} 的交流电流信号，
信号的转换速率约 8000 次/秒，显示更新约 3 次/秒。仪表的测量量程为
\SI{0.015}{\ampere}~\SI{15}{\ampere}，分辨力为 \SI{0.001}{\ampere}，与信
号电源地隔离，实现浮置输入。仪表的显示窗口为 4 位 LED 显示，为保证测量数
据的准确度，必须正确接入电流测试信号。当被测电流小于仪表电流量程时，可以
直接接入；否则，必须经过电流互感器 CT 接入 [@zw1400manual]。

该仪表不仅提供扩展功能，方便用户扩展其智能特性，提供测试与控制的灵活性，
而且提供满足一般工业要求的 MODBUS 规约 RTU 模式，可以自行编写或采用其它
符合该规约要求的通讯控制软件构成监控系统。

仪表发送或者接收的消息都是由一个十六进制字符组成的，其通讯规约如下：

1、字节格式如图 @fig:ch2byteformat 所示。

![字节格式](media/ch2byteformat.pdf){#fig:ch2byteformat}

每字节含 8 位二进制码，传输时加上一个起始位 (0)，一个停止位 (1)，共 10
位。D0 是字节的最低有效位，D7 是字节的最高有效位。先传低位，后传高位。

2、通讯数据格式：通讯时数据以字 (WORD—2 字节) 的形式回送，回送的每个字中
，高字节在前，低字节在后，如果 2 个字连续回送 (如：浮点或长整形)，则高字
在前，低字在后。格式如表 [@tbl:ch2commformat] 所示。

Table: 通讯数据格式 {#tbl:ch2commformat}

-----------------------------------------------------------------
数据类型   寄存器数   字节数   说明
---------- ---------- -------- ----------------------------------
字节数据   1          1        

整形数据   1          2        一次送回，高字节在前，\
                               低字节在后

长整形数\  2          4        分两个字送回，高字在前，\
浮点数据                       低字在后
-----------------------------------------------------------------

3、帧格式：包括读取和设置仪表寄存器内容

(1) 读取仪表寄存器内容 (功能码 03H)

上位机发送的帧格式如表 [@tbl:ch2hostsend] 所示。数据正常时，仪表回送的帧
格式如表 [@tbl:ch2instrsend] 所示。如果起始寄存器地址或寄存器个数错误，
仪表回送如表 [@tbl:ch2instrerror] 所示。

Table: 上位机发送的帧格式 {#tbl:ch2hostsend}

------------------------------------------------------------
顺序   代码                   示例   说明
------ ---------------------- ------ -----------------------
1      仪表地址               1      仪表的通讯地址 (1-255)

2      03H                    03H    功能码

3\     起始寄存器地址高字节\  10H\   寄存器起始地址
4      起始寄存器地址低字节   00H    

5\     寄存器个数高字节\      00H\   寄存器个数
6      寄存器个数低字节       02H    

7\     CRC16校验高字节\       C0H\   CRC校验数据
8      CRC16校验低字节        CBH    
------------------------------------------------------------

Table: 回送的帧格式 {#tbl:ch2instrsend}

顺序   代码                  说明
------ --------------------- -----------------------
1      仪表地址              仪表的通讯地址 (1-255)
2      03H                   功能码
3      回送数据域字节数 (M)   
4      第一个寄存器数据      
……     ……                    
       第 N 个寄存器数据       
M+4    CRC 校验高字节         
M+5    CRC 校验低字节         

Table: 仪表回送 {#tbl:ch2instrerror}

顺序   代码            示例   说明
------ --------------- ------ -----------------------
1      仪表地址        1      仪表的通讯地址 (1-255)
2      83H             83H    功能码
3      02H             02H    错误代码
4      CRC 检验高字节  C0H    
5      CRC 校验低字节  F1H    

(2) 设置仪表寄存器内容 (功能码 16H 或 10H 或 06H)

功能码 06H 写单路，将一个字 (2 字节) 数据写入仪表寄存器中，上位机发送的
帧格式如表 [@tbl:ch2singleset] 所示，如果写入正确，则仪表回送相同的数据。

功能码 16H 或 10H 写多路寄存器，上位机发送的帧格式如表
[@tbl:ch2multiset] 所示。如果写入成功的话，仪表回送帧格式如表
[@tbl:ch2instruecho] 所示。

如果通讯地址或写入的数据有错，则仪表回送如表 [@tbl:ch2instruerroeset] 所示。

Table: 单路设置帧格式 {#tbl:ch2singleset}

--------------------------------------------------------
顺序   代码               示例   说明
------ ------------------ ------ -----------------------
1      仪表地址           1      仪表的通讯地址(1-255)

2      06H                06H    功能码

3\     寄存器地址高字节\  10H\   寄存器地址1000H
4      寄存器地址低字节   00H    

5\     写入数据高字节\    00H\   写入数据0CH
6      写入数据低字节     0CH 
   
7\     CRC校验高字节\     8DH\   CRC校验数据8D0FH
8      CRC校验低字节      0FH    
--------------------------------------------------------

Table: 多路设置帧格式 {#tbl:ch2multiset}

--------------------------------------------------------------
顺序   代码                   示例   说明
------ ---------------------- ------ -------------------------
1      仪表地址               1      仪表的通讯地址(1-255)

2      16H或10H               10H    功能码

3      寄存器起始地址高字节   1FH    寄存器地址1F02H

4      寄存器起始地址低字节   02H    

5      寄存器个数高字节       00H    00H

6      寄存器个数低字节       02H    字节数据、整形数据：01H\
                                     浮点数据、长整形数：02H

7      字节数(M)              4      字节数据 ：01H\
                                     整形数据 ：02H\
                                     浮点数、长整形数：04H

8      数据高字节\            42H\   设置的浮点数为100
       数据次高字节\          C8H\   
       数据次低字节\          00H\   
       数据低字节             00H    

M+8    CRC校验高字节          6BH    CRC校验数据6BC0H

M+9    CRC校验低字节          C0H    
--------------------------------------------------------------

Table: 仪表回送帧格式 {#tbl:ch2instruecho}

--------------------------------------------------------
顺序   代码               示例   说明
------ ------------------ ------ -----------------------
1      仪表地址           1      仪表的通讯地址(1-255)

2      16H或10H           10H    功能码

3\     起始地址高字节\    1FH\   寄存器起始地址1F02H
4      起始地址低字节     02H    

5\     寄存器个数高字节\  00H\   寄存器个数2
6      寄存器个数低字节   02H    

7\     CRC校验高字节\     E7H\   CRC校验数据E7DCH
8      CRC校验低字节      DCH    
--------------------------------------------------------

Table: 仪表回送帧格式 {#tbl:ch2instruerroeset}

顺序   代码            说明
------ --------------- ------------------------
1      仪表地址        仪表的通讯地址(1-255)
2      96H或90H或86H   功能码—针对16H,10H,06H
3      03H             错误代码
4      CRC校验高字节   
5      CRC校验低字节   

4、通讯数据循环冗余校验

(1)循环冗余校验码（CRC 码）：是数据通信领域中最常用的一种差错校验码，其
特征是信息字段和校验字段的长度可以任意选定。

(2)生成 CRC 码的基本原理：任意一个由二进制位串组成的代码都可以和一个系数
仅为 ‘0’ 和 ‘1’ 取值的多项式一一对应。例如代码 1010111 对应的多项式为
$x^6+x^4+x^2+x+1$，而多项式为 $x^5+x^3+x^2+x+1$ 对应的代码 101111。仪表
的校验多项式为 $x^{16}+x^{12}+x^5+1$。

(3)CRC 码集选择的原则：若设码字长度为 $N$，信息字段为 $K$ 位，校验字段为
$R$ 位($N=K+R$)，则对于 CRC 码集中的任一码字，存在且仅存在一个 $R$ 次多
项式 $g(x)$，使得
$$V(x)=A(x)g(x)=x^R m(x)+r(x)$$
其中: $m(x)$ 为 $K$ 次信息多项式， $r(x)$ 为 $R-1$ 次校验多项式，
$g(x)$ 称为生成多项式：
$$g(x)=g_0+g_1+ g_2 x^2 + ... +g_{(R-1)} x^{(R-1)} + g_R x^R$$
发送方通过指定的 $g(x)$ 产生 CRC 码字，接收方则通过该 $g(x)$ 来验证收到
的 CRC 码字。

(4)CRC校验码软件生成方法：借助于多项式除法，其余数为校验字段。

5、通讯波特率：通讯波特率可以在 300、600、1200、2400、4800、9600 之间选
择。出厂时，仪表已经设置某一波特率。

6、仪表地址：仪表地址可以在 1-247 之间选择。仪表出厂时，已经设置某一地址。

7、通讯功能码：03H (召测数据) 16H (10H 或 06H) (数据设置)

## LabWindows/CVI 概述

### 什么是 LabWindows/CVI？

LabWindows/CVI 是美国 NI 公司推出的面向仪器与测控过程的 C/C++
[@surui2009; @kruglinski2005] 交互式开发平台，可以在多种操作系统 (如
Windows98/NT/2000、MacOS 和 UNIX) 下运行。它以 ANSI C 为核心，将功能强大、
使用灵活的 C 语言与数据采集、分析和表达等测控专业工具有机结合。它的集成
化开发、交互式编程方法、丰富的功能面板和库函数大大增强了 C 语言的功能，
为熟悉 C 语言的开发人员开发检测、数据采集、过程监控等系统提供了一个理想
的软件开发环境 [@shijuncheng2007; @zhangyigang2002; @liujunhua2003;
@liujunhua2001]。

LabWindows/CVI编程环境有四个主要的界面窗口：

(1) 工程窗口 (Project Windows)。工程窗口中列出了组成该工程的所有文件。

(2) 用户界面编辑窗口 (User Interface Editor Windows)。用户界面编辑窗口是用
来创建、编辑用户界面的，它所形成的文件为 `*.uir` 文件。用户界面相当于真
实仪器的操作面板，一个用户界面文件至少要有一个面板，面板上放置完全不同功
能的控件。图形化用户界面编辑窗口提供了非常快捷的创建、编辑面板和控件属性
的设置等功能，可在短时间里创建出符合要求的图形界面。

(3) 源代码编辑窗口 (Source Windows)。在源代码编辑窗口可创建或编辑 C 语言代
码文件，如编程所需的添加、删除、插入函数等基本编辑操作。

(4) 函数面板 (Function Panel)。函数面板是用户界面的基础，是对传统仪器中控
制面板的虚拟。在面板上，用户可以任意添加各种控件来建立用户界面。在源程序
编辑窗口中，如果要在程序某处插入函数，只需从函数所在的库中选中该函数，在
弹出的函数面板中填入该函数所需的参数后即可完成函数的插入。

使用 LabWindows/CVI 可以完成以下工作：

(1) 交互式程序开发。
(2) 具有功能强大的库函数，用来创建数据采集和仪器控制的应用程序。
(3) 充分利用完备的软件工具进行数据采集、分析和显示。
(4) 利用向导开发 IVI 仪器驱动程序和创建 ActiveX 服务器。
(5) 为其他程序开发 C 目标模块、动态链接库 (DLL)、C 语言库。

### 为什么用 LabWindows/CVI

LabWindows/CVI 平台简单易用、功能强大，可适用于有一定 C 语言基础的科技人
员，它不仅提供了对虚拟仪器的支持能力，还具有各种测试、控制和数值分析的能
力，具有图形建模简单、控制功能强大、实时性强、编程容易等优点。从软件开发
的角度来看，LabWindows/CVI 具有以下一些特点：

(1) 基于标准 C 语言，简单易学。
(2) 可视化、交互式的开发工具。具有人机交互界面编辑器，运用可视化交互技术
    实现“所见即所得”，使人机界面的实现直观简单。对每一个函数都提供了一个
    函数面板，用户可以通过函数面板交互地输入函数的每一个参数及属性值。这
    种交互式编程技术大大提高了工程设计的效率和可靠性。
(3) 具有程序自动生成的能力，可减少软件开发过程中代码编写的工作量。设计好
    的人机交互界面（虚拟仪器面板）存储在后缀名为．uir 的文件中。
    LabWindows/CVI自动生成原码头文件`.h`，自动声明界面对象常量及相关的回
    调函数，编程人员不必钻研这些技术。
(4) 具有齐全的软件工具包及功能强大的函数库，通过简单调用库函数就能驱动相
    应的总线的各种仪器和硬件板卡。这些工具包和函数库具有更高的效率，他使
    得程序的编写更简洁、直观。
(5) 完善的兼容性。借助于 LabWindows/CVI，有经验的 C/C++ 语言开发人员可以
    采用熟悉的 C 语言环境，如 VC，BC 等开发自己的虚拟仪器系统。另外，还
    可将仪器库函数及子程序编译成 32 位 DLL，以用于任中。
(6) 多种灵活的函数调用手段。所提供的变量显示窗口可观察程序变量和表达式的
    变化情况，还提供了单步执行、断点执行、过程跟踪、参数检查、运行时内存
    检查等多种调试手段，可更容易地对程序进行调试、排错。
(7) 强大的 Internet 功能，支持常用网络协议，方便网络仪器、远程测控仪器的开发。

## LabWindows/CVI 和其他虚拟仪器开发工具的比较

虚拟仪器的开发工具比较广泛，目前比较流行的有面向对象的编程技术和图形编程
技术。面向对象的可视化编程语言环境有 Visual C++、Visual Basic 等通用工具。
但相比较图形编程语言来说，其编程难度较大，开发周期较长且不易进行更改、
升级和维护等。而图形编程语言在这方面具有无可比拟的优势，它具有简单易学，
开发周期短，开发出的应用程序界面美观，功能强大。其中专门用于测量和控制方
面的虚拟仪器开发工具的代表产品有 HP 公司的 HP VEE、NI 公司的 LabVIEW、
LabWindows/CVI 等。

HP VEE 是一种工程可视化编程语言，它对整个语言做了彻底的图形化处理，并提
供了模块式的编程工具，同时还提供了数据流显示和程序流显示，非常适合于构成
测试和测量应用程序。在仪器控制方面，HP VEE 提供了两种使用方式（软面板方
式和直接输入输出方式）。 LabVIEW 的图形化程序设计是基于现代软件的面向对
象技术和数据流技术而发展起来的。用户能够通过连接功能模块来快速开发自己的
应用程序，甚至能够使用多路数据通道，实现同步操作。LabWindows/CVI 是用 C
语言构建仪器系统的交互式软件开发环境。其可以模块化方式对 C 语言进行编辑、
编译、连接和调试。LabWindows/CVI 软件把 C 语言的有力与柔性同虚拟仪器的
软件工具库结合起来，包含了 GPIB、RS232、VXI 总线、数据采集和分析库，且用
户自己开发的程序可在不同的平台上移植。

由于设计人员有 C 语言编程功底，且希望本设计可以更加深入、有效率，所以在
众多软件工具中选择 LabWindows/CVI 作为本设计的开发工具。
